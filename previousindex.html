<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CeoTech URL Shortener</title>
    <style>
        body, html {margin:0;padding:0;height:100%;font-family:Arial,sans-serif;overflow:hidden;}
        #app {max-width:420px;margin:50px auto;padding:20px;background:#fafafa;}
        input[type="url"] {width:100%;padding:10px;margin:10px 0;box-sizing:border-box;}
        button {width:100%;padding:10px;background:#4285f4;color:#fff;border:none;cursor:pointer;margin-top:5px;}
        button:hover {background:#3367d6;}
        #result {margin-top:20px;padding:15px;background:#f0f0f0;border-radius:5px;display:none;user-select:none;}
        code {background:#ddd;padding:2px 6px;border-radius:3px;}
        .qr {margin-top:15px;text-align:center;display:none;}
        .qr img {max-width:150px;border:1px solid #ccc;pointer-events:none;}
        .copy-btn,.gen-btn,.dl-btn {width:auto;display:inline-block;padding:6px 12px;font-size:0.9rem;margin:5px 2px;}

        /* 404 Page */
        #notFound {
            display:none;flex-direction:column;justify-content:center;align-items:center;
            height:100vh;background:#f8f8f8;color:#333;text-align:center;padding:20px;
        }
        #notFound h1 {font-size:3rem;margin:0;color:#d32f2f;}
        #notFound p {font-size:1.2rem;margin:10px 0;}
        #notFound a {color:#4285f4;text-decoration:none;font-weight:bold;}
        #notFound a:hover {text-decoration:underline;}

        /* DevTools Blocker */
        #blocker {
            position:fixed;top:0;left:0;width:100vw;height:100vh;
            background:#000;color:#fff;display:none;flex-direction:column;
            justify-content:center;align-items:center;z-index:9999;
            font-size:1.2rem;text-align:center;
        }
        #blocker.show {display:flex;}
    </style>
</head>
<body>

<!-- 404 PAGE -->
<div id="notFound">
    <h1>404</h1>
    <p><strong>Not Found</strong></p>
    <p>This link does not exist.</p>
    <p><a href="/">‚Üê Go back to URL Shortener</a></p>
</div>

<!-- MAIN APP -->
<div id="app">
    <h1>Enter Long URL to Shorten</h1>
    <form id="urlForm">
        <label for="url">Long URL:</label>
        <input type="url" id="url" name="url" placeholder="https://example.com/very-long-url" required>
        <button type="submit">Generate Short Code</button>
    </form>
    <div id="result"></div>
</div>

<!-- DEVTOOLS BLOCKER -->
<div id="blocker">
    <h2>Developer Tools Detected</h2>
    <p>Please close the inspector to continue.</p>
</div>

<script>
/* ---------- CONFIG ---------- */
const webAppUrl  = 'https://script.google.com/macros/s/AKfycbwYySRRrkayJpedOrzJj4KYOM18OQEgz8XWcUE0kyUf3iKo-k4UjmBDBoWc81vKRAuLTQ/exec';
const baseUrl    = location.origin;
const qrFileName = 'ceotech-url.png';
/* --------------------------- */

const app        = document.getElementById('app');
const notFound   = document.getElementById('notFound');
const blocker    = document.getElementById('blocker');
const form       = document.getElementById('urlForm');
const result     = document.getElementById('result');

let devtoolsOpen = false;
const THRESHOLD = 160;

/* ---------- ANTI-INSPECTOR ---------- */
document.addEventListener('contextmenu', e => e.preventDefault());
document.onkeydown = e => {
    if (e.keyCode === 123 || (e.ctrlKey && e.shiftKey && (e.keyCode === 73 || e.keyCode === 67))) return false;
};

const detect = () => {
    const w = window.outerWidth - window.innerWidth > THRESHOLD;
    const h = window.outerHeight - window.innerHeight > THRESHOLD;
    return w || h;
};

const checkDevtools = () => {
    const open = detect();
    if (open !== devtoolsOpen) {
        devtoolsOpen = open;
        if (open) {
            app.style.display = 'none';
            notFound.style.display = 'none';
            blocker.classList.add('show');
        } else {
            blocker.classList.remove('show');
            if (location.search.startsWith('?code=')) {
                handleRedirect();
            } else {
                app.style.display = 'block';
            }
        }
    }
};

setInterval(checkDevtools, 400);
window.addEventListener('resize', checkDevtools);

/* ---------- REDIRECT LOGIC ---------- */
function handleRedirect() {
    const params = new URLSearchParams(location.search);
    const code = params.get('code');
    if (!code) {
        app.style.display = 'block';
        return;
    }

    app.innerHTML = '<p>Redirecting...</p>';
    app.style.display = 'block';

    fetch(`${webAppUrl}?action=get&code=${encodeURIComponent(code)}`)
        .then(r => r.json())
        .then(data => {
            if (data.url) {
                window.location = data.url;
            } else {
                show404();
            }
        })
        .catch(() => show404());
}

function show404() {
    app.style.display = 'none';
    notFound.style.display = 'flex';
}

/* ---------- INITIAL LOAD ---------- */
if (location.search.startsWith('?code=')) {
    handleRedirect();
} else {
    app.style.display = 'block';
}

/* ---------- SHORTENER LOGIC ---------- */
form.addEventListener('submit', async e => {
    e.preventDefault();
    const longUrl = document.getElementById('url').value.trim();

    result.innerHTML = '<p>Generating code...</p>';
    result.style.display = 'block';

    try {
        const resp = await fetch(webAppUrl, {
            method: 'POST',
            headers: {'Content-Type': 'application/x-www-form-urlencoded'},
            body: 'url=' + encodeURIComponent(longUrl)
        });
        const data = await resp.json();
        if (data.error) throw new Error(data.error);

        const shortCode = data.shortCode;
        const shortUrl  = `${baseUrl}/?code=${shortCode}`;
        const qrUrl     = `https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=${encodeURIComponent(shortUrl)}`;

        result.innerHTML = `
            <strong>Success!</strong><br>
            Short code: <code>${shortCode}</code><br><br>
            Short URL: <a href="${shortUrl}" target="_blank">${shortUrl}</a>
            <button class="copy-btn" data-clipboard-text="${shortUrl}">Copy URL</button>

            <div style="margin-top:15px;">
                <button class="gen-btn" id="genQr">Generate QR</button>
            </div>

            <div class="qr" id="qrContainer">
                <p>QR Code:</p>
                <img src="${qrUrl}" alt="QR code" id="qrImg">
                <br>
                <button class="dl-btn" id="downloadQr">Download QR (${qrFileName})</button>
            </div>
        `;

        // Copy URL
        result.querySelectorAll('.copy-btn').forEach(b => {
            b.onclick = () => {
                navigator.clipboard.writeText(b.dataset.clipboardText).then(() => {
                    const txt = b.textContent;
                    b.textContent = 'Copied!';
                    setTimeout(() => b.textContent = txt, 1500);
                });
            };
        });

        // Show QR
        document.getElementById('genQr').onclick = () => {
            document.getElementById('qrContainer').style.display = 'block';
            document.getElementById('genQr').style.display = 'none';
        };

        // Download QR
        document.getElementById('downloadQr').onclick = () => {
            if (devtoolsOpen) return alert('Download blocked.');
            fetch(qrUrl)
                .then(r => r.blob())
                .then(blob => {
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url; a.download = qrFileName;
                    document.body.appendChild(a); a.click(); document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                });
        };

    } catch (err) {
        result.innerHTML = `<strong>Error:</strong> ${err.message}`;
    }
});
</script>
</body>
</html>

